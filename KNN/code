import pandas as pd
import numpy as np
import re
import nltk
from nltk.corpus import stopwords
from nltk.stem import PorterStemmer
from sklearn.feature_extraction.text import TfidfVectorizer
from sklearn.model_selection import train_test_split
from sklearn.metrics import accuracy_score, confusion_matrix, classification_report
from sklearn.neighbors import KNeighborsClassifier
import matplotlib.pyplot as plt
import seaborn as sns

nltk.download('stopwords')

# 1) Chargement du dataset
df = pd.read_csv("IMDB Dataset.csv")

# 2) Nettoyage du texte
stemmer = PorterStemmer()
stop_words = set(stopwords.words('english'))

def clean_text(text):
    text = re.sub(r'<.*?>', '', text)
    text = re.sub(r'[^a-zA-Z]', ' ', text)
    text = text.lower().split()
    text = [stemmer.stem(word) for word in text if word not in stop_words]
    return " ".join(text)

df["review_clean"] = df["review"].apply(clean_text)

# 3) Vectorisation TF-IDF
vectorizer = TfidfVectorizer(max_features=5000)
X = vectorizer.fit_transform(df["review_clean"])
y = df["sentiment"].map({"positive":1, "negative":0})

X_train, X_test, y_train, y_test = train_test_split(X, y, test_size=0.2, random_state=42)

# 4) Choix optimal de K
accuracy_scores = []
neighbors = range(1, 20)

for k in neighbors:
    model = KNeighborsClassifier(n_neighbors=k)
    model.fit(X_train, y_train)
    pred = model.predict(X_test)
    accuracy_scores.append(accuracy_score(y_test, pred))

plt.plot(neighbors, accuracy_scores)
plt.xlabel("Nombre de voisins (K)")
plt.ylabel("Accuracy")
plt.title("Choix du meilleur K")
plt.show()

best_k = neighbors[np.argmax(accuracy_scores)]
print("Meilleur K =", best_k)

# 5) Entraînement du modèle final
knn = KNeighborsClassifier(n_neighbors=best_k)
knn.fit(X_train, y_train)
pred = knn.predict(X_test)

# 6) Résultats
print("Accuracy du KNN:", accuracy_score(y_test, pred))
print(classification_report(y_test, pred))

cm = confusion_matrix(y_test, pred)
sns.heatmap(cm, annot=True, fmt="d", cmap="Blues")
plt.title("Matrice de confusion - KNN")
plt.show()
